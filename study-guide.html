<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Study Guide</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="dashboard-body">

    <nav class="nav-bar">
        <h2><i class="fas fa-lightbulb"></i> Personalized Study Guide</h2>
        <button onclick="window.location.href='dashboard.html'" style="width: auto;">Back to Home</button>
    </nav>

    <div class="quiz-setup" style="margin-bottom: 30px; text-align: center;">
        <h3>Ready to level up?</h3>
        <p>AI will analyze your quiz history and mistakes to build a custom plan.</p>
        <button onclick="generateStudyGuide()" id="gen-btn" style="max-width: 300px;">
            <i class="fas fa-magic"></i> Generate My Plan
        </button>
    </div>

    <div id="loading-spinner">
        <i class="fas fa-circle-notch fa-spin fa-3x"></i>
        <h3>Analyzing your performance...</h3>
        <p>Designing a strategy to fix your weak points.</p>
    </div>

    <div id="guide-container" class="feature-card" style="display:none; text-align: left; line-height: 1.8;">
        <div id="ai-response-content"></div>
    </div>

    <script src="config.js"></script>
    <script>
        async function generateStudyGuide() {
            const btn = document.getElementById('gen-btn');
            const spinner = document.getElementById('loading-spinner');
            const container = document.getElementById('guide-container');
            const content = document.getElementById('ai-response-content');

            // 1. Get User Data
            const history = JSON.parse(localStorage.getItem('quizHistory')) || [];
            const mistakes = JSON.parse(localStorage.getItem('mistakeNotebook')) || [];

            // UI Updates
            btn.disabled = true;
            btn.style.opacity = "0.5";
            spinner.style.display = "block";
            container.style.display = "none";

            // 2. Build the Persona/Prompt
            let prompt = "";
            
            if (history.length === 0) {
                // New User Prompt
                prompt = `
                    Act as an expert CBSE Class 10 tutor. 
                    I am a new student starting my preparation. 
                    Create a general "7-Day Kickstart Plan" covering key topics in Math, Science, and Social Science 
                    that are most important for board exams. 
                    Format the response in clean Markdown with headings and bullet points.
                `;
            } else {
                // Personalized Prompt
                // Summarize weak areas from mistakes
                const weakTopics = [...new Set(mistakes.map(m => m.topic))].join(", ");
                
                // Summarize strong/weak areas from scores
                let recentScores = history.slice(-5).map(h => `${h.topic} (${h.score}/${h.total})`).join(", ");

                prompt = `
                    Act as an expert CBSE Class 10 academic counselor.
                    Analyze my recent performance:
                    - Recent Quiz Scores: ${recentScores}
                    - Specific Weak Topics (Mistakes made in): ${weakTopics || "None recorded yet"}

                    Based on this, create a concise "3-Day Action Plan" to improve my weak areas.
                    If I have no weak areas listed, suggest advanced topics to master.
                    
                    Structure the response clearly:
                    1. **Analysis**: Briefly tell me what I'm good at and what needs work.
                    2. **The Plan**: Day 1, Day 2, Day 3 specific tasks.
                    3. **Pro Tip**: One exam hack.

                    Use Markdown formatting (Bold, Lists). Keep it motivating but strict.
                `;
            }

            try {
                // 3. Call Gemini API
                const modelName = aiConfig.model || "gemini-2.0-flash";
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${aiConfig.apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);

                const aiText = data.candidates[0].content.parts[0].text;

                // 4. Render Markdown
                content.innerHTML = marked.parse(aiText);
                
                // Show Result
                spinner.style.display = "none";
                container.style.display = "block";
                btn.disabled = false;
                btn.style.opacity = "1";
                btn.innerText = "Regenerate Plan";

            } catch (error) {
                console.error(error);
                alert("Error generating guide: " + error.message);
                spinner.style.display = "none";
                btn.disabled = false;
                btn.style.opacity = "1";
            }
        }
    </script>
</body>
</html>
