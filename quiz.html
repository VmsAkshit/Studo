<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartQuiz AI</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script src="config.js"></script>
</head>
<body>

    <div class="container">
        
        <div id="setup-panel">
            <div style="text-align: center;">
                <h2><i class="fas fa-brain"></i> SmartQuiz AI</h2>
                <div id="login-status-container" style="margin-top: 10px;">
                    <span id="login-status" class="status-badge status-loading">Checking access...</span>
                </div>
            </div>

            <form onsubmit="event.preventDefault(); generateQuiz();">
                <div style="margin-top: 25px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px dashed var(--glass-border);">
                    <label style="margin-top: 0; color: var(--accent);"><i class="fas fa-microchip"></i> AI Model</label>
                    <select id="ai-model-selector" style="border-color: rgba(236, 72, 153, 0.3);">
                        <option value="gemini-2.5-flash">Gemini 2.5 Flash (Experimental)</option>
                        <option value="gemini-3-flash-preview">Gemini 3.0 Preview (Bleeding Edge)</option>
                    </select>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <label>Subject</label>
                        <select id="q-subject">
                            <option value="Mathematics">Mathematics</option>
                            <option value="Science">Science</option>
                            <option value="History">History</option>
                            <option value="Geography">Geography</option>
                            <option value="English">English</option>
                            <option value="Coding">Coding</option>
                        </select>
                    </div>
                    <div>
                        <label>Questions</label>
                        <select id="q-count">
                            <option value="5">5 Questions</option>
                            <option value="10">10 Questions</option>
                            <option value="15">15 Questions</option>
                        </select>
                    </div>
                </div>

                <label>Specific Topic</label>
                <input type="text" id="q-topic" placeholder="e.g. Calculus, Photosynthesis, WWII..." required>

                <label>Difficulty Level</label>
                <select id="q-diff">
                    <option value="Easy">Easy</option>
                    <option value="Medium" selected>Medium</option>
                    <option value="Hard">Hard</option>
                    <option value="Expert">Expert (Olympiad Level)</option>
                </select>

                <button type="submit" class="primary-btn">
                    <i class="fas fa-magic"></i> Generate Quiz
                </button>
                
                <button type="button" class="secondary-btn" onclick="window.location.href='dashboard.html'">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </button>
            </form>
        </div>

        <div id="loading-spinner" style="display:none; text-align:center; padding: 40px 0;">
            <i class="fas fa-atom fa-spin fa-4x"></i>
            <h3 style="margin-top: 20px; color: white;">Crafting your quiz...</h3>
            <p id="loading-text" style="color: var(--text-muted);">Consulting the AI knowledge base</p>
        </div>

        <div id="quiz-panel" style="display:none;">
            </div>

        <div id="result-panel" style="display:none; text-align:center;">
            <h2>Quiz Complete!</h2>
            <div style="font-size: 4rem; font-weight: 800; margin: 20px 0; background: linear-gradient(to right, var(--success), var(--primary)); -webkit-background-clip: text; color: transparent;">
                <span id="score-display">0/0</span>
            </div>
            
            <div id="save-status-container" style="margin-bottom: 30px;">
                <span id="save-status" class="status-badge status-loading">Saving results...</span>
            </div>
            
            <button onclick="location.reload()" class="primary-btn">
                <i class="fas fa-redo"></i> Take Another Quiz
            </button>
            <button onclick="window.location.href='dashboard.html'" class="secondary-btn">
                <i class="fas fa-home"></i> Dashboard
            </button>
        </div>

    </div>

    <script>
        // --- 1. SETUP FIREBASE ---
        // Use the safe public config from config.js
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- 2. AUTH CHECK ---
        auth.onAuthStateChanged(user => {
            const statusLabel = document.getElementById('login-status');
            if (user) {
                statusLabel.innerHTML = `<i class="fas fa-check-circle"></i> Logged in as ${user.email.split('@')[0]}`;
                statusLabel.className = 'status-badge status-success';
            } else {
                statusLabel.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Guest Mode (Not Saving)`;
                statusLabel.className = 'status-badge status-error';
            }
        });

        // --- 3. GLOBAL VARS ---
        let currentQuestions = [];
        let userAnswers = {};
        let quizScore = 0;

        // --- 4. GENERATE FUNCTION ---
        async function generateQuiz() {
            const subject = document.getElementById('q-subject').value;
            const topic = document.getElementById('q-topic').value;
            const count = document.getElementById('q-count').value;
            const difficulty = document.getElementById('q-diff').value;
            const selectedModel = document.getElementById('ai-model-selector').value;

            if(!topic) { alert("Please enter a topic!"); return; }

            // UI Transition
            document.getElementById('setup-panel').style.display = 'none';
            document.getElementById('loading-spinner').style.display = 'block';
            document.getElementById('loading-text').innerText = `Using ${selectedModel} to generate ${count} questions...`;

            // Use the SECURE KEY from config.js
            const SAFE_API_KEY = aiConfig.apiKey; 
            
            const prompt = `
                Act as a strict teacher. Generate ${count} MCQs for Subject: "${subject}", Topic: "${topic}". 
                Difficulty: ${difficulty}.
                Return ONLY a raw JSON array.
                IMPORTANT: Write all Math equations using standard LaTeX enclosed in $ symbols (e.g. $E=mc^2$).
                Structure: [{"question": "...", "options": ["A","B","C","D"], "correctIndex": 0, "explanation": "..."}]
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${SAFE_API_KEY}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                
                let aiText = data.candidates[0].content.parts[0].text;
                const jsonStartIndex = aiText.indexOf('[');
                const jsonEndIndex = aiText.lastIndexOf(']') + 1;
                
                if (jsonStartIndex === -1) throw new Error("AI returned invalid format. Try again.");

                currentQuestions = JSON.parse(aiText.substring(jsonStartIndex, jsonEndIndex));
                renderQuiz();

            } catch (error) {
                console.error(error);
                alert(`Error: ${error.message}\nTip: Try a different model or simplified topic.`);
                location.reload();
            }
        }

        // --- 5. RENDER FUNCTION ---
        function renderQuiz() {
            document.getElementById('loading-spinner').style.display = 'none';
            const container = document.getElementById('quiz-panel');
            container.innerHTML = '';
            container.style.display = 'block';

            currentQuestions.forEach((q, index) => {
                const card = document.createElement('div');
                card.className = 'question-card';
                card.style.animationDelay = `${index * 0.1}s`; // Staggered animation
                
                let optionsHtml = '';
                q.options.forEach((opt, i) => {
                    optionsHtml += `<button class="option-btn" onclick="selectAnswer(${index}, ${i}, this)">${opt}</button>`;
                });
                
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <span style="background:rgba(255,255,255,0.1); padding:4px 10px; border-radius:10px; font-size:0.8rem;">Question ${index + 1}</span>
                    </div>
                    <h3>${q.question}</h3>
                    <div id="opts-${index}">${optionsHtml}</div>
                    <div id="explain-${index}" class="explanation">
                        <i class="fas fa-lightbulb" style="color:#facc15; margin-right:8px;"></i> ${q.explanation}
                    </div>
                `;
                container.appendChild(card);
            });

            const submitBtn = document.createElement('button');
            submitBtn.className = 'primary-btn';
            submitBtn.innerHTML = '<i class="fas fa-check-double"></i> Submit Answers';
            submitBtn.style.marginTop = "30px";
            submitBtn.onclick = calculateResults;
            container.appendChild(submitBtn);

            // Render Math
            if (window.MathJax) {
                window.MathJax.typesetPromise();
            }
        }

        // --- 6. INTERACTION ---
        function selectAnswer(qIndex, optIndex, btnElement) {
            userAnswers[qIndex] = optIndex;
            const parent = document.getElementById(`opts-${qIndex}`);
            const buttons = parent.getElementsByClassName('option-btn');
            for(let btn of buttons) btn.classList.remove('selected');
            btnElement.classList.add('selected');
        }

        // --- 7. RESULTS ---
        async function calculateResults() {
            quizScore = 0;
            const topic = document.getElementById('q-topic').value;
            
            // Visual grading
            currentQuestions.forEach((q, index) => {
                const userChoice = userAnswers[index];
                const correctChoice = q.correctIndex;
                const optsContainer = document.getElementById(`opts-${index}`);
                
                if(optsContainer) {
                    const buttons = optsContainer.getElementsByClassName('option-btn');
                    
                    // Show explanation
                    document.getElementById(`explain-${index}`).style.display = 'block';

                    // Mark correct answer Green
                    if(buttons[correctChoice]) buttons[correctChoice].classList.add('correct');
                    
                    // Logic
                    if (userChoice === correctChoice) {
                        quizScore++;
                    } else if (userChoice !== undefined && buttons[userChoice]) {
                        buttons[userChoice].classList.add('wrong');
                    }
                }
            });

            // Scroll to top to see grading
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Show Final Score Panel after 2 seconds delay to let user review
            setTimeout(async () => {
                document.getElementById('quiz-panel').style.display = 'none';
                document.getElementById('result-panel').style.display = 'block';
                document.getElementById('score-display').innerText = `${quizScore} / ${currentQuestions.length}`;
                
                // SAVE DATA
                const statusSpan = document.getElementById('save-status');
                const user = auth.currentUser;
                
                if (!user) {
                    statusSpan.innerText = "Guest Mode - Not Saved";
                    statusSpan.className = 'status-badge status-error';
                    return;
                }

                try {
                    await db.collection('students').doc(user.uid).collection('history').add({
                        topic: topic, 
                        score: quizScore, 
                        total: currentQuestions.length, 
                        date: new Date().toLocaleDateString(), 
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    statusSpan.innerHTML = '<i class="fas fa-check"></i> Progress Saved';
                    statusSpan.className = 'status-badge status-success';
                } catch (e) {
                    statusSpan.innerText = "Error Saving";
                    statusSpan.className = 'status-badge status-error';
                }
            }, 2000);
        }
    </script>
</body>
</html>
