<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartQuiz - Practice Mode</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>

    <div style="width: 100%; max-width: 800px; margin: 20px auto;">
        
        <div id="setup-panel" class="quiz-setup">
            <h2><i class="fas fa-robot"></i> AI Quiz Generator</h2>
            
            <p id="login-status" style="font-size: 0.9rem; color: #666; background: #eee; padding: 5px; border-radius: 4px; display: inline-block;">
                Checking login status...
            </p>

            <div style="margin-top: 15px;">
                <label style="color: #ef4444; font-weight: bold;">Select AI Model</label>
                <select id="ai-model-selector" style="border: 2px solid #ef4444; background: #fff0f0;">
                    <option value="gemini-2.0-flash-lite-preview-02-05" selected>Gemini 2.0 Flash Lite (Best for Free Tier)</option>
                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp</option>
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                </select>
            </div>
            
            <label>Subject</label>
            <select id="q-subject">
                <option value="Mathematics">Mathematics</option>
                <option value="Science">Science</option>
                <option value="Social Science">Social Science</option>
                <option value="English">English</option>
            </select>

            <label>Chapter / Topic Name</label>
            <input type="text" id="q-topic" placeholder="e.g. Trigonometry, Carbon Compounds">

            <label>Number of Questions</label>
            <select id="q-count">
                <option value="5">5 Questions</option>
                <option value="10">10 Questions</option>
            </select>

            <label>Difficulty</label>
            <select id="q-diff">
                <option value="Easy">Easy</option>
                <option value="Medium">Medium</option>
                <option value="Hard">Hard</option>
            </select>

            <button onclick="generateQuiz()" style="margin-top: 20px;">Generate Quiz</button>
            <button onclick="window.location.href='dashboard.html'" style="margin-top: 10px; background: #555;">Back to Dashboard</button>
        </div>

        <div id="loading-spinner" style="display:none; text-align:center;">
            <i class="fas fa-circle-notch fa-spin fa-3x" style="color: #8b5cf6;"></i>
            <h3>Creating unique questions...</h3>
            <p id="loading-text">Connecting to AI...</p>
        </div>

        <div id="quiz-panel"></div>

        <div id="result-panel" style="display:none; text-align:center;" class="quiz-setup">
            <h2>Quiz Completed!</h2>
            <h1 id="score-display" style="font-size: 3rem; color: #8b5cf6;">0/0</h1>
            
            <p id="save-status" style="font-weight: bold; color: orange; padding: 10px; border: 1px dashed #ccc; margin: 10px 0;">
                Processing results...
            </p>
            
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button onclick="location.reload()" style="background: #2563eb;">Take Another</button>
                <button onclick="window.location.href='dashboard.html'" style="background: #10b981;">Back to Dashboard</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. YOUR NEW FIREBASE CONFIGURATION (SmartQuiz-f3264) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCJivdJTeZ2VnDw50Q2ZL3u4AiUj89Nols",
            authDomain: "smartquiz-f3264.firebaseapp.com",
            projectId: "smartquiz-f3264",
            storageBucket: "smartquiz-f3264.firebasestorage.app",
            messagingSenderId: "657819908694",
            appId: "1:657819908694:web:ca5bc42a9cf7b142e499f7"
        };

        // --- GEMINI API KEY ---
        const API_KEY = "AIzaSyDNE1AzM8_EXD-deTh-YUFTsgERM-bVPi8"; 

        // --- 2. INITIALIZE FIREBASE ---
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Check Login immediately
        auth.onAuthStateChanged(user => {
            const statusLabel = document.getElementById('login-status');
            if (user) {
                console.log("Logged in as:", user.email);
                statusLabel.innerText = "✅ Logged in as " + user.email;
                statusLabel.style.color = "green";
                statusLabel.style.background = "#dcfce7";
            } else {
                console.warn("User NOT logged in.");
                statusLabel.innerText = "⚠️ Not logged in! Data will NOT save.";
                statusLabel.style.color = "red";
                statusLabel.style.background = "#fee2e2";
            }
        });

        // --- 3. QUIZ LOGIC ---
        let currentQuestions = [];
        let userAnswers = {};
        let quizScore = 0;

        async function generateQuiz() {
            const subject = document.getElementById('q-subject').value;
            const topic = document.getElementById('q-topic').value;
            const count = document.getElementById('q-count').value;
            const difficulty = document.getElementById('q-diff').value;
            const selectedModel = document.getElementById('ai-model-selector').value;

            if(!topic) { alert("Please enter a topic!"); return; }

            document.getElementById('setup-panel').style.display = 'none';
            document.getElementById('loading-spinner').style.display = 'block';
            document.getElementById('loading-text').innerText = `Using ${selectedModel}...`;

            const prompt = `
                Act as a teacher. Generate ${count} MCQs for Subject: "${subject}", Topic: "${topic}". 
                Difficulty: ${difficulty}.
                Return ONLY a raw JSON array.
                Structure: [{"question": "...", "options": ["A","B","C","D"], "correctIndex": 0, "explanation": "..."}]
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${API_KEY}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                
                let aiText = data.candidates[0].content.parts[0].text;
                const jsonStartIndex = aiText.indexOf('[');
                const jsonEndIndex = aiText.lastIndexOf(']') + 1;
                
                if (jsonStartIndex === -1) throw new Error("Invalid format from AI.");

                currentQuestions = JSON.parse(aiText.substring(jsonStartIndex, jsonEndIndex));
                renderQuiz();

            } catch (error) {
                console.error(error);
                alert(`Error: ${error.message}\nTry selecting a different model.`);
                document.getElementById('loading-spinner').style.display = 'none';
                document.getElementById('setup-panel').style.display = 'block';
            }
        }

        function renderQuiz() {
            document.getElementById('loading-spinner').style.display = 'none';
            const container = document.getElementById('quiz-panel');
            container.innerHTML = '';
            container.style.display = 'block';

            currentQuestions.forEach((q, index) => {
                const card = document.createElement('div');
                card.className = 'question-card';
                let optionsHtml = '';
                q.options.forEach((opt, i) => {
                    optionsHtml += `<button class="option-btn" onclick="selectAnswer(${index}, ${i}, this)">${opt}</button>`;
                });
                card.innerHTML = `<h3>Q${index + 1}: ${q.question}</h3><div id="opts-${index}">${optionsHtml}</div><div id="explain-${index}" class="explanation"><strong>Explanation:</strong> ${q.explanation}</div>`;
                container.appendChild(card);
            });

            const submitBtn = document.createElement('button');
            submitBtn.innerText = "Submit Quiz";
            submitBtn.style.marginTop = "20px";
            submitBtn.onclick = calculateResults;
            container.appendChild(submitBtn);
        }

        function selectAnswer(qIndex, optIndex, btnElement) {
            userAnswers[qIndex] = optIndex;
            const parent = document.getElementById(`opts-${qIndex}`);
            const buttons = parent.getElementsByClassName('option-btn');
            for(let btn of buttons) btn.classList.remove('selected');
            btnElement.classList.add('selected');
        }

        // --- 4. SAFE SUBMIT FUNCTION ---
        async function calculateResults() {
            try {
                // STEP 1: UI Calculations
                quizScore = 0;
                const topic = document.getElementById('q-topic').value;
                
                currentQuestions.forEach((q, index) => {
                    const userChoice = userAnswers[index];
                    const correctChoice = q.correctIndex;
                    
                    const optsContainer = document.getElementById(`opts-${index}`);
                    if(optsContainer) {
                        const buttons = optsContainer.getElementsByClassName('option-btn');
                        const explainDiv = document.getElementById(`explain-${index}`);
                        if(explainDiv) explainDiv.style.display = 'block';

                        if(buttons[correctChoice]) buttons[correctChoice].classList.add('correct');
                        
                        if (userChoice === correctChoice) {
                            quizScore++;
                        } else if (userChoice !== undefined && buttons[userChoice]) {
                            buttons[userChoice].classList.add('wrong');
                        }
                    }
                });

                // STEP 2: Force Show Results (Cannot fail)
                document.getElementById('quiz-panel').style.display = 'none';
                document.getElementById('result-panel').style.display = 'block';
                document.getElementById('score-display').innerText = `${quizScore} / ${currentQuestions.length}`;
                
                const saveStatus = document.getElementById('save-status');
                saveStatus.innerText = "Attempting to save...";

                // STEP 3: Database Save
                const user = firebase.auth().currentUser;
                
                if (!user) {
                    saveStatus.innerText = "⚠️ Not logged in. Data NOT saved.";
                    saveStatus.style.color = "red";
                    return;
                }

                // Save History
                await db.collection('students').doc(user.uid).collection('history').add({
                    topic: topic, 
                    score: quizScore, 
                    total: currentQuestions.length, 
                    date: new Date().toLocaleDateString(), 
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Save Mistakes
                for(let i=0; i<currentQuestions.length; i++) {
                    if (userAnswers[i] !== currentQuestions[i].correctIndex) {
                        await db.collection('students').doc(user.uid).collection('mistakes').add({
                            question: currentQuestions[i].question, 
                            answer: currentQuestions[i].options[currentQuestions[i].correctIndex], 
                            explanation: currentQuestions[i].explanation, 
                            topic: topic, 
                            date: new Date().toLocaleDateString(), 
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }

                saveStatus.innerText = "✅ Saved Successfully to Dashboard!";
                saveStatus.style.color = "green";

            } catch (err) {
                console.error("Critical Error:", err);
                const saveStatus = document.getElementById('save-status');
                saveStatus.innerText = "Error: " + err.message;
                saveStatus.style.color = "red";
                alert("Something went wrong showing results. Check console.");
            }
        }
    </script>
</body>
</html>
