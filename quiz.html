<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartQuiz - Practice Mode</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>

    <div style="width: 100%; max-width: 800px; margin: 20px auto;">
        
        <div id="setup-panel" class="quiz-setup">
            <h2><i class="fas fa-robot"></i> AI Quiz Generator</h2>
            <p>Enter your topic and let AI build a test for you.</p>
            
            <label>Subject</label>
            <select id="q-subject">
                <option value="Mathematics">Mathematics</option>
                <option value="Science">Science</option>
                <option value="Social Science">Social Science</option>
                <option value="English">English</option>
            </select>

            <label>Chapter / Topic Name</label>
            <input type="text" id="q-topic" placeholder="e.g. Trigonometry, Carbon Compounds">

            <label>Number of Questions</label>
            <select id="q-count">
                <option value="5">5 Questions</option>
                <option value="10">10 Questions</option>
            </select>

            <label>Difficulty</label>
            <select id="q-diff">
                <option value="Easy">Easy</option>
                <option value="Medium">Medium</option>
                <option value="Hard">Hard</option>
            </select>

            <button onclick="generateQuiz()" style="margin-top: 20px;">Generate Quiz</button>
            <button onclick="window.location.href='dashboard.html'" style="margin-top: 10px; background: #555;">Back to Dashboard</button>
        </div>

        <div id="loading-spinner" style="display:none; text-align:center;">
            <i class="fas fa-circle-notch fa-spin fa-3x" style="color: #8b5cf6;"></i>
            <h3>Creating unique questions...</h3>
        </div>

        <div id="quiz-panel"></div>

        <div id="result-panel" style="display:none; text-align:center;" class="quiz-setup">
            <h2>Quiz Completed!</h2>
            <h1 id="score-display" style="font-size: 3rem; color: #8b5cf6;">0/0</h1>
            <p id="feedback-msg">Saving results...</p>
            
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button onclick="location.reload()">Take Another</button>
                <button onclick="window.location.href='dashboard.html'" style="background: #10b981;">Back to Dashboard</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAxUsVjZc3A8D1pNAxqcOd4gkdvkpn-kLs",
            authDomain: "jaycmun-4f2cf.firebaseapp.com",
            projectId: "jaycmun-4f2cf",
            storageBucket: "jaycmun-4f2cf.firebasestorage.app",
            messagingSenderId: "771042098346",
            appId: "1:771042098346:web:cef5dddd892788f6f224d3",
            measurementId: "G-1Y3EKYR648"
        };

        const aiConfig = {
            // PASTE YOUR NEW KEY HERE IF THIS ONE IS BLOCKED
            apiKey: "AIzaSyDNE1AzM8_EXD-deTh-YUFTsgERM-bVPi8", 
            model: "gemini-2.0-flash-exp" 
        };

        // --- 2. INITIALIZE FIREBASE ---
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Check Login Status
        let currentUser = null;
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                console.log("User logged in:", user.email);
            } else {
                console.log("User not logged in");
                // Optional: Redirect to login if you want to force it
                // window.location.href = 'index.html'; 
            }
        });

        // --- 3. QUIZ LOGIC ---
        let currentQuestions = [];
        let userAnswers = {};
        let quizScore = 0;

        async function generateQuiz() {
            const subject = document.getElementById('q-subject').value;
            const topic = document.getElementById('q-topic').value;
            const count = document.getElementById('q-count').value;
            const difficulty = document.getElementById('q-diff').value;

            if(!topic) { alert("Please enter a topic!"); return; }

            document.getElementById('setup-panel').style.display = 'none';
            document.getElementById('loading-spinner').style.display = 'block';

            const prompt = `
                Act as a teacher. Generate ${count} MCQs for Subject: "${subject}", Topic: "${topic}". 
                Difficulty: ${difficulty}.
                Return ONLY a raw JSON array.
                Structure: [{"question": "...", "options": ["A","B","C","D"], "correctIndex": 0, "explanation": "..."}]
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${aiConfig.model}:generateContent?key=${aiConfig.apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);
                if (!data.candidates) throw new Error("AI sent empty response.");

                let aiText = data.candidates[0].content.parts[0].text;
                
                // Clean JSON
                const jsonStartIndex = aiText.indexOf('[');
                const jsonEndIndex = aiText.lastIndexOf(']') + 1;
                
                if (jsonStartIndex === -1) throw new Error("Invalid JSON format.");

                currentQuestions = JSON.parse(aiText.substring(jsonStartIndex, jsonEndIndex));
                renderQuiz();

            } catch (error) {
                console.error(error);
                alert("Error: " + error.message);
                location.reload();
            }
        }

        function renderQuiz() {
            document.getElementById('loading-spinner').style.display = 'none';
            const container = document.getElementById('quiz-panel');
            container.innerHTML = '';
            container.style.display = 'block';

            currentQuestions.forEach((q, index) => {
                const card = document.createElement('div');
                card.className = 'question-card';
                let optionsHtml = '';
                q.options.forEach((opt, i) => {
                    optionsHtml += `<button class="option-btn" onclick="selectAnswer(${index}, ${i}, this)">${opt}</button>`;
                });
                card.innerHTML = `<h3>Q${index + 1}: ${q.question}</h3><div id="opts-${index}">${optionsHtml}</div><div id="explain-${index}" class="explanation"><strong>Explanation:</strong> ${q.explanation}</div>`;
                container.appendChild(card);
            });

            // Submit Button
            const submitBtn = document.createElement('button');
            submitBtn.innerText = "Submit Quiz";
            submitBtn.style.marginTop = "20px";
            submitBtn.onclick = calculateResults;
            container.appendChild(submitBtn);
        }

        function selectAnswer(qIndex, optIndex, btnElement) {
            userAnswers[qIndex] = optIndex;
            const parent = document.getElementById(`opts-${qIndex}`);
            const buttons = parent.getElementsByClassName('option-btn');
            for(let btn of buttons) btn.classList.remove('selected');
            btnElement.classList.add('selected');
        }

        // --- 4. SUBMIT & SAVE LOGIC ---
        async function calculateResults() {
            quizScore = 0;
            const topic = document.getElementById('q-topic').value;

            // 1. Grading Loop
            currentQuestions.forEach((q, index) => {
                const userChoice = userAnswers[index];
                const correctChoice = q.correctIndex;
                const buttons = document.getElementById(`opts-${index}`).getElementsByClassName('option-btn');
                document.getElementById(`explain-${index}`).style.display = 'block';

                if(buttons[correctChoice]) buttons[correctChoice].classList.add('correct');

                if (userChoice === correctChoice) {
                    quizScore++;
                } else {
                    if (userChoice !== undefined) {
                        buttons[userChoice].classList.add('wrong');
                        
                        // Save Mistake (Only if logged in)
                        if(currentUser) {
                            db.collection('students').doc(currentUser.uid).collection('mistakes').add({
                                question: q.question, 
                                answer: q.options[correctChoice], 
                                explanation: q.explanation, 
                                topic: topic, 
                                date: new Date().toLocaleDateString(), 
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                    }
                }
            });

            // 2. Save History (Only if logged in)
            if(currentUser) {
                try {
                    await db.collection('students').doc(currentUser.uid).collection('history').add({
                        topic: topic, 
                        score: quizScore, 
                        total: currentQuestions.length, 
                        date: new Date().toLocaleDateString(), 
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    document.getElementById('feedback-msg').innerText = "Results saved successfully!";
                } catch(e) { 
                    console.error("Save Error:", e);
                    document.getElementById('feedback-msg').innerText = "Error saving results.";
                }
            } else {
                document.getElementById('feedback-msg').innerText = "Not logged in. Results not saved.";
            }

            // 3. Show Results Panel
            document.getElementById('quiz-panel').style.display = 'none';
            document.getElementById('result-panel').style.display = 'block';
            document.getElementById('score-display').innerText = `${quizScore} / ${currentQuestions.length}`;
            
            // Note: We do NOT automatically redirect here. 
            // The user must see their score first, then click the "Back to Dashboard" button in the result-panel.
        }
    </script>
</body>
</html>
