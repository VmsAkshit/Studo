<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SmartQuiz - Practice Mode</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div style="width: 100%; max-width: 800px; margin: 20px;">
        
        <div id="setup-panel" class="quiz-setup">
            <h2><i class="fas fa-robot"></i> AI Quiz Generator</h2>
            <p>Enter your topic and let AI build a test for you.</p>
            
            <label>Subject</label>
            <select id="q-subject">
                <option value="Mathematics">Mathematics</option>
                <option value="Science">Science</option>
                <option value="Social Science">Social Science</option>
                <option value="English">English</option>
            </select>

            <label>Chapter / Topic Name</label>
            <input type="text" id="q-topic" placeholder="e.g. Trigonometry, Carbon Compounds">

            <label>Number of Questions</label>
            <select id="q-count">
                <option value="5">5 Questions</option>
                <option value="10">10 Questions</option>
            </select>

            <label>Difficulty</label>
            <select id="q-diff">
                <option value="Easy">Easy</option>
                <option value="Medium">Medium</option>
                <option value="Hard">Hard</option>
            </select>

            <button onclick="generateQuiz()" style="margin-top: 20px;">Generate Quiz</button>
        </div>

        <div id="loading-spinner" style="display:none; text-align:center;">
            <i class="fas fa-circle-notch fa-spin fa-3x"></i>
            <h3>Creating unique questions...</h3>
        </div>

        <div id="quiz-panel"></div>

        <div id="result-panel" style="display:none; text-align:center;" class="quiz-setup">
            <h2>Quiz Completed!</h2>
            <h1 id="score-display" style="font-size: 3rem; color: #8b5cf6;">0/0</h1>
            <p id="feedback-msg">Saving results to cloud...</p>
            <button onclick="location.reload()">Take Another Quiz</button>
            <button onclick="window.location.href='dashboard.html'" style="background:#333;">Go Home</button>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="auth.js"></script>

    <script>
        console.log("Embedded Quiz Engine Loaded");

        let currentQuestions = [];
        let userAnswers = {};
        let quizScore = 0;

        async function generateQuiz() {
            console.log("Button Clicked");
            
            // 1. Check Config
            if (typeof aiConfig === 'undefined') {
                alert("Error: config.js not loaded. Check console.");
                return;
            }

            const subject = document.getElementById('q-subject').value;
            const topic = document.getElementById('q-topic').value;
            const count = document.getElementById('q-count').value;
            const difficulty = document.getElementById('q-diff').value;

            if(!topic) { alert("Please enter a topic!"); return; }

            document.getElementById('setup-panel').style.display = 'none';
            document.getElementById('loading-spinner').style.display = 'block';

            const prompt = `
                Act as a teacher. Generate ${count} MCQs for Subject: "${subject}", Topic: "${topic}". 
                Difficulty: ${difficulty}.
                Return ONLY a raw JSON array.
                Structure: [{"question": "...", "options": ["A","B","C","D"], "correctIndex": 0, "explanation": "..."}]
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${aiConfig.model}:generateContent?key=${aiConfig.apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                let aiText = data.candidates[0].content.parts[0].text;
                const jsonStartIndex = aiText.indexOf('[');
                const jsonEndIndex = aiText.lastIndexOf(']') + 1;
                
                currentQuestions = JSON.parse(aiText.substring(jsonStartIndex, jsonEndIndex));
                renderQuiz();

            } catch (error) {
                console.error(error);
                alert("Error: " + error.message);
                location.reload();
            }
        }

        function renderQuiz() {
            document.getElementById('loading-spinner').style.display = 'none';
            const container = document.getElementById('quiz-panel');
            container.innerHTML = '';
            container.style.display = 'block';

            currentQuestions.forEach((q, index) => {
                const card = document.createElement('div');
                card.className = 'question-card';
                let optionsHtml = '';
                q.options.forEach((opt, i) => {
                    optionsHtml += `<button class="option-btn" onclick="selectAnswer(${index}, ${i}, this)">${opt}</button>`;
                });
                card.innerHTML = `<h3>Q${index + 1}: ${q.question}</h3><div id="opts-${index}">${optionsHtml}</div><div id="explain-${index}" class="explanation"><strong>Explanation:</strong> ${q.explanation}</div>`;
                container.appendChild(card);
            });

            const submitBtn = document.createElement('button');
            submitBtn.innerText = "Submit Quiz";
            submitBtn.style.marginTop = "20px";
            submitBtn.onclick = calculateResults;
            container.appendChild(submitBtn);
        }

        function selectAnswer(qIndex, optIndex, btnElement) {
            userAnswers[qIndex] = optIndex;
            const parent = document.getElementById(`opts-${qIndex}`);
            const buttons = parent.getElementsByClassName('option-btn');
            for(let btn of buttons) btn.classList.remove('selected');
            btnElement.classList.add('selected');
        }

        async function calculateResults() {
            const user = (typeof firebase !== 'undefined') ? firebase.auth().currentUser : null;
            quizScore = 0;
            const topic = document.getElementById('q-topic').value;

            currentQuestions.forEach((q, index) => {
                const userChoice = userAnswers[index];
                const correctChoice = q.correctIndex;
                const buttons = document.getElementById(`opts-${index}`).getElementsByClassName('option-btn');
                document.getElementById(`explain-${index}`).style.display = 'block';

                if(buttons[correctChoice]) buttons[correctChoice].classList.add('correct');
                if (userChoice === correctChoice) quizScore++;
                else if (userChoice !== undefined) {
                    buttons[userChoice].classList.add('wrong');
                    if(user) {
                        db.collection('students').doc(user.uid).collection('mistakes').add({
                            question: q.question, answer: q.options[correctChoice], explanation: q.explanation, topic: topic, date: new Date().toLocaleDateString(), timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }
            });

            if(user) {
                try {
                    await db.collection('students').doc(user.uid).collection('history').add({
                        topic: topic, score: quizScore, total: currentQuestions.length, date: new Date().toLocaleDateString(), timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch(e) { console.error(e); }
            }

            document.getElementById('quiz-panel').style.display = 'none';
            document.getElementById('result-panel').style.display = 'block';
            document.getElementById('score-display').innerText = `${quizScore} / ${currentQuestions.length}`;
            document.getElementById('feedback-msg').innerText = user ? "Saved to Cloud!" : "Login to save results.";
        }
    </script>
</body>
</html>
