<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studo - Quiz</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="config.js"></script>
</head>
<body>
    <div class="container">
        <div id="setup-panel">
            <div style="text-align: center;">
                <h2><i class="fas fa-graduation-cap"></i> Studo</h2>
                <span id="login-status" class="status-badge status-loading">Checking access...</span>
            </div>

            <form onsubmit="event.preventDefault(); generateQuiz();">
                <div style="margin-top: 25px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px dashed var(--glass-border);">
                    <label style="margin-top: 0; color: var(--accent);">AI Model</label>
                    <select id="ai-model-selector" style="border-color: rgba(236, 72, 153, 0.3);">
                        <option value="gemini-2.5-flash">Gemini 2.5 Flash (Experimental)</option>
                        <option value="gemini-3-flash-preview">Gemini 3.0 Preview (Bleeding Edge)</option>
                    </select>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div><label>Subject</label><select id="q-subject"><option value="Mathematics">Mathematics</option><option value="Science">Science</option><option value="History">History</option><option value="English">English</option><option value="Coding">Coding</option></select></div>
                    <div><label>Questions</label><select id="q-count"><option value="5">5</option><option value="10">10</option><option value="15">15</option></select></div>
                </div>

                <label>Topic</label><input type="text" id="q-topic" placeholder="e.g. Calculus, Photosynthesis, WWII..." required>
                <label>Difficulty</label><select id="q-diff"><option value="Easy">Easy</option><option value="Medium" selected>Medium</option><option value="Hard">Hard</option></select>

                <button type="submit" class="primary-btn"><i class="fas fa-magic"></i> Generate Quiz</button>
                <button type="button" class="secondary-btn" onclick="window.location.href='dashboard.html'">Back to Dashboard</button>
            </form>
        </div>

        <div id="loading-spinner" style="display:none; text-align:center; padding: 40px 0;">
            <i class="fas fa-atom fa-spin fa-4x" style="color: var(--accent);"></i>
            <h3 style="margin-top: 20px; color: white;">Studo is thinking...</h3>
            <p id="loading-model-text" style="color: #94a3b8; margin-top: 10px;"></p>
        </div>

        <div id="quiz-panel" style="display:none;"></div>

        <div id="result-panel" style="display:none; text-align:center;">
            <h2>Quiz Complete!</h2>
            <div style="font-size: 4rem; font-weight: 800; margin: 20px 0; background: linear-gradient(to right, var(--success), var(--primary)); -webkit-background-clip: text; color: transparent;">
                <span id="score-display">0/0</span>
            </div>
            <span id="save-status" class="status-badge status-loading">Saving results...</span>
            <button onclick="location.reload()" class="primary-btn">Take Another</button>
            <button onclick="window.location.href='dashboard.html'" class="secondary-btn">Dashboard</button>
        </div>
    </div>

    <script>
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        auth.onAuthStateChanged(user => {
            const statusLabel = document.getElementById('login-status');
            if (user) { statusLabel.innerHTML = `Logged in as ${user.email.split('@')[0]}`; statusLabel.className = 'status-badge status-success'; }
            else { statusLabel.innerHTML = `Guest Mode (Not Saving)`; statusLabel.className = 'status-badge status-error'; }
        });

        let currentQuestions = [], userAnswers = {}, quizScore = 0;

        async function generateQuiz() {
            const subject = document.getElementById('q-subject').value;
            const topic = document.getElementById('q-topic').value;
            const count = document.getElementById('q-count').value;
            const diff = document.getElementById('q-diff').value;
            const model = document.getElementById('ai-model-selector').value;

            document.getElementById('setup-panel').style.display = 'none';
            document.getElementById('loading-spinner').style.display = 'block';
            document.getElementById('loading-model-text').innerText = `Using ${model}...`;

            const prompt = `Act as a teacher. Generate ${count} MCQs for Subject: "${subject}", Topic: "${topic}". Difficulty: ${diff}. Return ONLY a raw JSON array. CRITICAL: If you use LaTeX for math, you MUST double-escape backslashes. Example: Use "$\\\\frac{1}{2}$" instead of "$\\frac{1}{2}$". Structure: [{"question": "...", "options": ["A","B","C","D"], "correctIndex": 0, "explanation": "..."}]`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${aiConfig.apiKey}`, {
                    method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                let aiText = data.candidates[0].content.parts[0].text;
                let jsonString = aiText.substring(aiText.indexOf('['), aiText.lastIndexOf(']') + 1);
                
                try { currentQuestions = JSON.parse(jsonString); } 
                catch (e) { jsonString = jsonString.replace(/\\([^\/"\\bfnrtu])/g, '\\\\$1'); currentQuestions = JSON.parse(jsonString); }

                renderQuiz();
            } catch (e) { alert(`Error: ${e.message}`); location.reload(); }
        }

        function renderQuiz() {
            document.getElementById('loading-spinner').style.display = 'none';
            const container = document.getElementById('quiz-panel');
            container.innerHTML = ''; container.style.display = 'block';

            currentQuestions.forEach((q, index) => {
                let optionsHtml = '';
                q.options.forEach((opt, i) => { optionsHtml += `<button class="option-btn" onclick="selectAnswer(${index}, ${i}, this)">${opt}</button>`; });
                container.innerHTML += `<div class="question-card"><h3>${q.question}</h3><div id="opts-${index}">${optionsHtml}</div><div id="explain-${index}" class="explanation">ðŸ’¡ ${q.explanation}</div></div>`;
            });

            const btn = document.createElement('button'); btn.className = 'primary-btn'; btn.innerText = 'Submit Answers'; btn.onclick = calculateResults;
            container.appendChild(btn);
            if (window.MathJax) window.MathJax.typesetPromise();
        }

        function selectAnswer(q, opt, btn) {
            userAnswers[q] = opt;
            const buttons = document.getElementById(`opts-${q}`).getElementsByClassName('option-btn');
            for(let b of buttons) b.classList.remove('selected');
            btn.classList.add('selected');
        }

        async function calculateResults() {
            quizScore = 0;
            const topic = document.getElementById('q-topic').value;
            const user = auth.currentUser;
            const batch = db.batch();
            let hasMistakes = false;
            
            currentQuestions.forEach((q, index) => {
                const btns = document.getElementById(`opts-${index}`).getElementsByClassName('option-btn');
                document.getElementById(`explain-${index}`).style.display = 'block';
                if(btns[q.correctIndex]) btns[q.correctIndex].classList.add('correct');
                
                if(userAnswers[index] === q.correctIndex) { quizScore++; } 
                else {
                    if(userAnswers[index] !== undefined) btns[userAnswers[index]].classList.add('wrong');
                    if(user) {
                        hasMistakes = true;
                        const mistakeRef = db.collection('students').doc(user.uid).collection('mistakes').doc();
                        batch.set(mistakeRef, { question: q.question, answer: q.options[q.correctIndex], userChoice: userAnswers[index] !== undefined ? q.options[userAnswers[index]] : "Skipped", explanation: q.explanation, topic: topic, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                    }
                }
            });

            window.scrollTo({ top: 0, behavior: 'smooth' });
            setTimeout(async () => {
                document.getElementById('quiz-panel').style.display = 'none';
                document.getElementById('result-panel').style.display = 'block';
                document.getElementById('score-display').innerText = `${quizScore} / ${currentQuestions.length}`;
                if(user) {
                    await db.collection('students').doc(user.uid).collection('history').add({ topic, score: quizScore, total: currentQuestions.length, date: new Date().toLocaleDateString(), timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                    if(hasMistakes) await batch.commit();
                    document.getElementById('save-status').innerText = "Saved to Studo Cloud"; document.getElementById('save-status').className = 'status-badge status-success';
                }
            }, 2000);
        }
    </script>
</body>
</html>
